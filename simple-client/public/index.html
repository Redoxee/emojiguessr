<html>
    <link href="style.css" rel="stylesheet" type="text/css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <!-- <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script> -->
    <script src="bxios.js"></script>
    <script src="js/Utils.js"></script>
    <script src="js/Pseudonymous.js"></script>
    <script src="js/PseudoPicker.js"></script>
    <link href="css/PseudoPicker.css" rel="stylesheet" type="text/css">

    <body>
        <div id="game">
            <div id="title">ðŸŒ¶EmojiGuessrðŸ”¥</div>
            <div id="playerInfo">
                <div id='playerLabel'></div>
                <div id='chefLabel'></div>
            </div>
            <div id = "NameBuilder">
                <p>Select a name</p>
            </div>
            <div id='questionLabel'></div>
            <div id="hintHolder"></div>
            <emoji-picker></emoji-picker>
            <div id="responsesHolder"></div>
        </div>
        <button id="nextRoundButton">Next Round</button>
        <div id="credits">Made by AntonMakesGames with help from FranÃ§ois Eoche</div>
        <div id='debug'>
            <button id="reset">R</button>
            <button id='pause'>P</button>
        </div>
    </body>

    <script type="text/javascript">
        // const gameSrvUrl = "https://antonmakesgames.alwaysdata.net/";
        const gameSrvUrl = "http://localhost:8100";
        
        const nameBuilderElement = document.getElementById('NameBuilder');

        let playerLabel = document.getElementById('playerLabel');
        let chefLabel = document.getElementById('chefLabel');
        let questionLabel = document.getElementById('questionLabel');
        let emojiPicker =document.querySelector('emoji-picker'); 
        let hintHolder = document.getElementById('hintHolder');
        let responsesHolder = document.getElementById('responsesHolder');
        let nextRoundButton = document.getElementById('nextRoundButton');
        let resetButton = document.getElementById("reset");
        let lastFrame = -1;

        let playerId = 0;
        let chefId = -1;
        let question = null;
        let refreshRate = 2000;
        let hints = [];
        let pauseRefresh = false;
        let hintBtns = [];

        setVisibility(emojiPicker, false);
        setVisibility(playerLabel, false);
        setVisibility(responsesHolder, false);
        setVisibility(nextRoundButton, false);

        {
            const pseudonymPicker = create_pseudonyme_picker();
            nameBuilderElement.appendChild(pseudonymPicker);
            pseudonymPicker.addEventListener('OnPseudoPicked', (event) => {
                console.log(event.detail);
                playerId = event.detail.id;
                
                playerLabel.replaceChildren(`You're ${event.detail.name}`);
                setVisibility(playerLabel, true);
                setVisibility(nameBuilderElement, false);
                refresh();
            })
        }

        const axiosGame = bxios.create({
            baseURL: gameSrvUrl,
        });
        
        window.addEventListener("load", async () => {
            const res = await axiosGame.get();
            console.log(res);
            
            const responses = res.data.responses;

            let responsesBtn = [];
            for (let i= 0; i < responses.length; ++i){
                const index = i;
                const responseButton = document.createElement('button');
                responseButton.textContent = responses[index];
                responseButton.addEventListener('click',()=>{
                    axiosGame.put(`/response/${playerId}/${index}`);
                });

                responsesBtn.push(responseButton);
            }

            responsesHolder.replaceChildren(...responsesBtn);
        });

        const becomeChefButton = document.createElement('Button');
        becomeChefButton.id = "chefButton";
        becomeChefButton.textContent = "I'm the game master"; 
        becomeChefButton.addEventListener('click', (event)=>{
            axiosGame.put(`/chefId/${playerId}`);
        });

        async function refresh() {
            if(playerId && !pauseRefresh)
            {
                const res = await axiosGame.get(`/refresh/${playerId}`);
                console.log(res);
                if(lastFrame !== res.data.frame) {
                    lastFrame = res.data.frame;
                    
                    const srvChef = Number(res.data.chefId);
                    if (res.data.question) {
                        question = res.data.question;
                        questionLabel.textContent = question;
                    }
                    else
                    {
                        questionLabel.textContent = '';
                    }
                    
                    if(srvChef !== chefId)
                    {
                        chefId = srvChef;
                        if(chefId) {
                            if(chefId === playerId) {
                                chefLabel.replaceChildren(`you're ${GetNameFromId(playerId)}, the game master`);
                            } else 
                            {
                                chefLabel.replaceChildren(`The game master is ${GetNameFromId(chefId)}`);
                            }
                        }
                        else {
                            chefLabel.replaceChildren(becomeChefButton);
                            setVisibility(emojiPicker, false);
                        }
                    }
                    
                    setVisibility(playerLabel, chefId !== playerId);

                    hints = res.data.hints;
                    
                    if(chefId === playerId) {
                        setVisibility(emojiPicker, true)
                        setVisibility(nextRoundButton, true);
                    }
                    else {
                        setVisibility(nextRoundButton, false);
                    }
                    
                    {
                        setVisibility(hintHolder, true);

                        const numberOfHintItem = hints.length + 1;
                        if (hintHolder.childNodes.length !== numberOfHintItem) {
                            let hintItems = [];
                            for (let i = 0; i < numberOfHintItem; ++i){
                                const hint = document.createElement('div');
                                hint.id = "hint";
                                hintItems.push(hint);
                            }
                            
                            hintHolder.replaceChildren(...hintItems);
                        }
                        
                        for (let i = 0; i < numberOfHintItem; ++i) {
                            const hintItem = hintHolder.childNodes[i];
                            if (i < hints.length) {
                                let emo = document.createElement('p');
                                emo.textContent = hints[i];
                                
                                hintItem.replaceChildren(emo);
                            }
                            else {
                                hintItem.replaceChildren("");
                            }
                        }
                        
                        setVisibility(responsesHolder, playerId !== chefId);
                    }
                }
            }

            setTimeout(refresh, refreshRate);
        }

        resetButton.addEventListener('click',(event)=> {
            axiosGame.put('/reset');
        });
        
        let pauseButton = document.getElementById('pause');
        pauseButton.addEventListener('click', ()=> {
            pauseRefresh = !pauseRefresh;
        });

        emojiPicker.addEventListener('emoji-click', (event)=>{
            axiosGame.put(`/hint/${event.detail.unicode}`);
        });
       
        nextRoundButton.addEventListener('click', (event)=> {
            axiosGame.put('/nextRound'); 
        });

    </script>
</html>